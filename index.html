<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tennis Score Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    
    <script>
        // Simple cloud storage using KV.link (free, no API key needed)
        const STORAGE_URL = 'https://kv.link/';
        
        class TennisApp {
            constructor() {
                this.matches = [];
                this.players = [];
                this.view = 'matches';
                this.showForm = false;
                this.expandedMatch = null;
                this.storageKey = this.getStorageKey();
                this.init();
            }
            
            getStorageKey() {
                const params = new URLSearchParams(window.location.search);
                let key = params.get('id');
                if (!key) {
                    key = 'tennis_' + Math.random().toString(36).substr(2, 9);
                    window.history.replaceState({}, '', '?id=' + key);
                }
                return key;
            }
            
            async init() {
                await this.loadData();
                this.render();
                setInterval(() => this.loadData(), 15000);
            }
            
            async loadData() {
                try {
                    const response = await fetch(STORAGE_URL + this.storageKey);
                    if (response.ok) {
                        const text = await response.text();
                        if (text) {
                            const data = JSON.parse(text);
                            this.matches = data.matches || [];
                            this.players = data.players || [];
                            this.render();
                        }
                    }
                } catch (e) {
                    console.log('Using local data');
                }
            }
            
            async saveData() {
                const data = JSON.stringify({
                    matches: this.matches,
                    players: this.players
                });
                
                try {
                    await fetch(STORAGE_URL + this.storageKey, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: data
                    });
                } catch (e) {
                    console.error('Save failed:', e);
                }
            }
            
            addMatch(player1, player2, sets, date) {
                const p1Wins = sets.filter(s => parseInt(s.p1) > parseInt(s.p2)).length;
                const p2Wins = sets.filter(s => parseInt(s.p2) > parseInt(s.p1)).length;
                const winner = p1Wins > p2Wins ? 1 : p2Wins > p1Wins ? 2 : 0;
                
                const match = {
                    id: Date.now(),
                    player1: player1,
                    player2: player2,
                    sets: sets,
                    date: date,
                    winner: winner
                };
                
                this.matches.unshift(match);
                
                [player1, player2].forEach((name, idx) => {
                    let player = this.players.find(p => p.name.toLowerCase() === name.toLowerCase());
                    if (!player) {
                        player = { name: name, wins: 0, losses: 0, matches: 0 };
                        this.players.push(player);
                    }
                    player.matches++;
                    if (winner === idx + 1) player.wins++;
                    else if (winner !== 0) player.losses++;
                });
                
                this.saveData();
                this.render();
            }
            
            deleteMatch(id) {
                if (!confirm('Delete this match?')) return;
                
                const match = this.matches.find(m => m.id === id);
                this.matches = this.matches.filter(m => m.id !== id);
                
                this.players = this.players.map(p => {
                    if (p.name.toLowerCase() === match.player1.toLowerCase() || 
                        p.name.toLowerCase() === match.player2.toLowerCase()) {
                        const isP1 = p.name.toLowerCase() === match.player1.toLowerCase();
                        return {
                            ...p,
                            matches: p.matches - 1,
                            wins: p.wins - (match.winner === (isP1 ? 1 : 2) ? 1 : 0),
                            losses: p.losses - (match.winner !== 0 && match.winner !== (isP1 ? 1 : 2) ? 1 : 0)
                        };
                    }
                    return p;
                }).filter(p => p.matches > 0);
                
                this.saveData();
                this.render();
            }
            
            render() {
                const root = document.getElementById('root');
                root.innerHTML = `
                    <div class="min-h-screen bg-gradient-to-br from-green-50 to-emerald-100 p-4">
                        <div class="max-w-2xl mx-auto">
                            <div class="text-center mb-4">
                                <h1 class="text-2xl font-bold text-green-800 mb-1">üèÜ Tennis Tracker</h1>
                                <p class="text-green-600 text-sm mb-2">Track scores with your tennis group!</p>
                                <button onclick="app.copyLink()" class="text-xs bg-green-600 text-white px-4 py-2 rounded-full hover:bg-green-700">
                                    üìã Copy Share Link
                                </button>
                            </div>

                            <div class="flex items-center gap-2 mb-4">
                                <button onclick="app.refresh()" class="px-3 py-2 bg-white text-green-700 rounded-lg hover:bg-green-50 shadow-sm text-sm">
                                    üîÑ Refresh
                                </button>
                                <div class="flex-1 flex gap-2">
                                    ${this.renderTab('matches', 'üìÖ Matches')}
                                    ${this.renderTab('stats', 'üìä Stats')}
                                    ${this.renderTab('leaderboard', 'üë• Leaders')}
                                </div>
                            </div>

                            ${this.view === 'matches' ? this.renderMatches() : ''}
                            ${this.view === 'stats' ? this.renderStats() : ''}
                            ${this.view === 'leaderboard' ? this.renderLeaderboard() : ''}

                            <div class="mt-6 text-center text-xs text-green-600">
                                Auto-refreshes every 15 seconds
                            </div>
                        </div>
                    </div>
                `;
            }
            
            renderTab(name, label) {
                const active = this.view === name;
                return `
                    <button onclick="app.setView('${name}')" 
                        class="flex-1 py-2 px-2 rounded-lg font-medium text-sm transition-all ${
                            active ? 'bg-green-600 text-white shadow-md' : 'bg-white text-green-700 hover:bg-green-50'
                        }">
                        ${label}
                    </button>
                `;
            }
            
            renderMatches() {
                if (!this.showForm && this.matches.length === 0) {
                    return `
                        <button onclick="app.toggleForm()" class="w-full py-3 bg-green-600 text-white rounded-xl font-medium hover:bg-green-700">
                            ‚ûï Add Match
                        </button>
                        <div class="text-center py-8 text-green-600">No matches yet. Add your first match!</div>
                    `;
                }
                
                return `
                    ${!this.showForm ? `
                        <button onclick="app.toggleForm()" class="w-full mb-4 py-3 bg-green-600 text-white rounded-xl font-medium hover:bg-green-700">
                            ‚ûï Add Match
                        </button>
                    ` : this.renderForm()}
                    
                    <div class="space-y-3">
                        ${this.matches.map(m => this.renderMatch(m)).join('')}
                    </div>
                `;
            }
            
            renderForm() {
                return `
                    <div class="bg-white rounded-xl p-4 shadow-md mb-4">
                        <h3 class="font-semibold text-green-800 mb-3">New Match</h3>
                        <div class="grid grid-cols-2 gap-3 mb-3">
                            <input id="p1" placeholder="Player 1" class="p-2 border border-green-200 rounded-lg" list="players">
                            <input id="p2" placeholder="Player 2" class="p-2 border border-green-200 rounded-lg" list="players">
                        </div>
                        <datalist id="players">
                            ${this.players.map(p => `<option value="${p.name}">`).join('')}
                        </datalist>
                        <input id="date" type="date" value="${new Date().toISOString().split('T')[0]}" 
                            class="w-full p-2 border border-green-200 rounded-lg mb-3">
                        
                        <div class="space-y-2 mb-3">
                            <div class="flex justify-between items-center">
                                <span class="text-sm font-medium text-green-700">Set Scores</span>
                                <button onclick="app.addSet()" class="text-xs text-green-600">+ Add Set</button>
                            </div>
                            <div id="sets">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="text-xs text-gray-500 w-12">Set 1</span>
                                    <input type="number" min="0" max="7" placeholder="P1" class="set-p1 w-16 p-2 border rounded-lg text-center">
                                    <span class="text-gray-400">-</span>
                                    <input type="number" min="0" max="7" placeholder="P2" class="set-p2 w-16 p-2 border rounded-lg text-center">
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex gap-2">
                            <button onclick="app.toggleForm()" class="flex-1 py-2 bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200">Cancel</button>
                            <button onclick="app.submitMatch()" class="flex-1 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Save Match</button>
                        </div>
                    </div>
                `;
            }
            
            renderMatch(match) {
                const expanded = this.expandedMatch === match.id;
                return `
                    <div class="bg-white rounded-xl shadow-md overflow-hidden">
                        <div class="p-4 cursor-pointer" onclick="app.toggleExpand(${match.id})">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-1 flex-wrap">
                                        <span class="font-semibold ${match.winner === 1 ? 'text-green-600' : 'text-gray-700'}">
                                            ${match.player1} ${match.winner === 1 ? 'üèÜ' : ''}
                                        </span>
                                        <span class="text-gray-400">vs</span>
                                        <span class="font-semibold ${match.winner === 2 ? 'text-green-600' : 'text-gray-700'}">
                                            ${match.winner === 2 ? 'üèÜ' : ''} ${match.player2}
                                        </span>
                                    </div>
                                    <div class="text-sm text-gray-500">${new Date(match.date).toLocaleDateString()}</div>
                                    <div class="text-sm font-mono text-gray-600 mt-1">
                                        ${match.sets.map(s => s.p1 + '-' + s.p2).join(' ¬∑ ')}
                                    </div>
                                </div>
                                <button onclick="event.stopPropagation(); app.deleteMatch(${match.id})" 
                                    class="text-red-400 hover:text-red-600 p-1">üóëÔ∏è</button>
                            </div>
                        </div>
                        ${expanded ? `
                            <div class="px-4 pb-4 border-t border-gray-100">
                                <div class="grid grid-cols-2 gap-4 mt-3">
                                    ${this.renderPlayerStats(match.player1)}
                                    ${this.renderPlayerStats(match.player2)}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }
            
            renderPlayerStats(name) {
                const p = this.players.find(pl => pl.name.toLowerCase() === name.toLowerCase());
                const winRate = p && p.matches > 0 ? Math.round((p.wins / p.matches) * 100) : 0;
                const wins = p ? p.wins : 0;
                const losses = p ? p.losses : 0;
                
                return `
                    <div class="text-center p-2 bg-gray-50 rounded-lg">
                        <div class="font-medium text-gray-700 text-sm">${name}</div>
                        <div class="text-xs text-gray-500">${winRate}% win rate</div>
                        <div class="text-xs text-gray-400">${wins}W - ${losses}L</div>
                    </div>
                `;
            }
            
            renderStats() {
                const totalSets = this.matches.reduce((a, m) => a + m.sets.length, 0);
                
                return `
                    <div class="space-y-4">
                        <div class="bg-white rounded-xl p-4 shadow-md">
                            <h3 class="font-semibold text-green-800 mb-3">Overall Statistics</h3>
                            <div class="grid grid-cols-3 gap-4 text-center">
                                <div class="p-3 bg-green-50 rounded-lg">
                                    <div class="text-2xl font-bold text-green-600">${this.matches.length}</div>
                                    <div class="text-xs text-green-700">Total Matches</div>
                                </div>
                                <div class="p-3 bg-green-50 rounded-lg">
                                    <div class="text-2xl font-bold text-green-600">${this.players.length}</div>
                                    <div class="text-xs text-green-700">Players</div>
                                </div>
                                <div class="p-3 bg-green-50 rounded-lg">
                                    <div class="text-2xl font-bold text-green-600">${totalSets}</div>
                                    <div class="text-xs text-green-700">Sets Played</div>
                                </div>
                            </div>
                        </div>
                        
                        ${this.players.map(p => this.renderPlayerCard(p)).join('')}
                    </div>
                `;
            }
            
            renderPlayerCard(p) {
                const winRate = p.matches > 0 ? Math.round((p.wins / p.matches) * 100) : 0;
                return `
                    <div class="bg-white rounded-xl p-4 shadow-md">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="font-semibold text-green-800">${p.name}</h3>
                            <span class="text-sm text-green-600 font-medium">${winRate}% win rate</span>
                        </div>
                        <div class="h-2 bg-gray-200 rounded-full overflow-hidden mb-2">
                            <div class="h-full bg-green-500" style="width: ${winRate}%"></div>
                        </div>
                        <div class="flex justify-between text-sm text-gray-600">
                            <span>üèÜ ${p.wins} wins</span>
                            <span>üòî ${p.losses} losses</span>
                            <span>üéæ ${p.matches} matches</span>
                        </div>
                    </div>
                `;
            }
            
            renderLeaderboard() {
                const sorted = [...this.players].sort((a, b) => {
                    const aRate = a.matches ? a.wins / a.matches : 0;
                    const bRate = b.matches ? b.wins / b.matches : 0;
                    return bRate - aRate || b.wins - a.wins;
                });
                
                if (sorted.length === 0) {
                    return '<div class="bg-white rounded-xl p-8 text-center text-gray-500">No players yet</div>';
                }
                
                return `
                    <div class="bg-white rounded-xl shadow-md overflow-hidden">
                        <div class="p-4 border-b border-gray-100">
                            <h3 class="font-semibold text-green-800">Leaderboard</h3>
                        </div>
                        <div class="divide-y divide-gray-100">
                            ${sorted.map((p, idx) => this.renderLeaderboardRow(p, idx)).join('')}
                        </div>
                    </div>
                `;
            }
            
            renderLeaderboardRow(p, idx) {
                const medals = ['ü•á', 'ü•à', 'ü•â'];
                const bgColors = [
                    'bg-yellow-400 text-yellow-900',
                    'bg-gray-300 text-gray-700',
                    'bg-orange-300 text-orange-800',
                    'bg-gray-100 text-gray-600'
                ];
                const winRate = p.matches ? Math.round((p.wins / p.matches) * 100) : 0;
                
                return `
                    <div class="p-4 flex items-center gap-4">
                        <div class="w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm ${bgColors[Math.min(idx, 3)]}">
                            ${idx < 3 ? medals[idx] : idx + 1}
                        </div>
                        <div class="flex-1">
                            <div class="font-medium text-gray-800">${p.name}</div>
                            <div class="text-xs text-gray-500">${p.wins}W - ${p.losses}L (${p.matches} matches)</div>
                        </div>
                        <div class="text-right">
                            <div class="text-lg font-bold text-green-600">${winRate}%</div>
                            <div class="text-xs text-gray-500">win rate</div>
                        </div>
                    </div>
                `;
            }
            
            setView(view) {
                this.view = view;
                this.render();
            }
            
            toggleForm() {
                this.showForm = !this.showForm;
                this.render();
            }
            
            toggleExpand(id) {
                this.expandedMatch = this.expandedMatch === id ? null : id;
                this.render();
            }
            
            addSet() {
                const container = document.getElementById('sets');
                const count = container.children.length;
                if (count < 5) {
                    const div = document.createElement('div');
                    div.className = 'flex items-center gap-2 mb-2';
                    div.innerHTML = `
                        <span class="text-xs text-gray-500 w-12">Set ${count + 1}</span>
                        <input type="number" min="0" max="7" placeholder="P1" class="set-p1 w-16 p-2 border rounded-lg text-center">
                        <span class="text-gray-400">-</span>
                        <input type="number" min="0" max="7" placeholder="P2" class="set-p2 w-16 p-2 border rounded-lg text-center">
                    `;
                    container.appendChild(div);
                }
            }
            
            submitMatch() {
                const p1 = document.getElementById('p1').value.trim();
                const p2 = document.getElementById('p2').value.trim();
                const date = document.getElementById('date').value;
                
                if (!p1 || !p2) {
                    alert('Please enter both player names');
                    return;
                }
                
                const sets = [];
                const p1Inputs = document.querySelectorAll('.set-p1');
                const p2Inputs = document.querySelectorAll('.set-p2');
                
                for (let i = 0; i < p1Inputs.length; i++) {
                    const s1 = p1Inputs[i].value;
                    const s2 = p2Inputs[i].value;
                    if (s1 && s2) {
                        sets.push({ p1: s1, p2: s2 });
                    }
                }
                
                if (sets.length === 0) {
                    alert('Please enter at least one set score');
                    return;
                }
                
                this.addMatch(p1, p2, sets, date);
                this.showForm = false;
            }
            
            copyLink() {
                const url = window.location.href;
                navigator.clipboard.writeText(url).then(() => {
                    alert('Share link copied! Send this to your friends.');
                });
            }
            
            async refresh() {
                await this.loadData();
            }
        }
        
        const app = new TennisApp();
    </script>
</body>
</html>
